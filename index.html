<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Calendar</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none; /* Disable text selection globally */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            display: flex;
            gap: 20px;
            align-items: flex-end; 
        }

        /* Header */
        .header {
            display: flex;
            justify-content: center; /* Center the month-nav */
            align-items: center;
            margin-bottom: 30px;
            padding: 0 10px;
            position: relative;
        }

        .hamburger {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            z-index: 10;
        }

        .hamburger:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .current-month {
            font-size: 24px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        /* Calendar Main Content (Calendar + Controls) */
        .calendar-main-content {
            flex: 2; /* Adjust flex-basis */
            display: flex;
            flex-direction: column;
        }

        /* Calendar Container */
        .calendar-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: #2a2a2a;
            margin-bottom: 30px;
            flex-grow: 1; /* Allows calendar to fill available height */
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #3a3a3a;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #3a3a3a;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 1px;
        }

        .day-header {
            background: #2a2a2a;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            transition: background 0.2s;
        }
        .day-header:hover {
            background: #3a3a3a;
        }

        .calendar-day {
            background: #2a2a2a;
            padding: 8px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            min-width: 0; /* FIX: Allow grid items to shrink and prevent horizontal expansion */
        }

        .calendar-day:hover {
            background: #3a3a3a;
        }

        .calendar-day.other-month {
            color: #666;
        }

        .calendar-day.today {
            background: #007AFF;
            color: white;
        }

        .calendar-day.selected {
            background: #4CAF50;
            color: white;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .day-events {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event-item {
            padding: 2px 4px;
            font-size: 10px;
            margin-bottom: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Add Event Form */
        .add-event-form {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 0 10px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .add-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #0056b3;
        }

        .event-input {
            flex: 1;
            min-width: 150px; /* Ensure input doesn't get too small */
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            user-select: text; /* Re-enable text selection for input */
        }

        .event-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .event-checkboxes {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #007AFF;
        }

        .checkbox-group label {
            font-size: 12px;
            color: #cccccc;
        }

        /* Sidebars Container */
        .sidebars-container {
            flex: 1; /* Sidebars take remaining space */
            display: flex;
            flex-direction: row; /* Sidebars side-by-side */
            gap: 20px; /* Gap between sidebar columns */
            min-width: 250px; /* Minimum width for sidebars */
            margin-bottom: 30px; /* Match calendar-container's margin-bottom */
        }

        .sidebar-column {
            display: flex;
            flex-direction: column;
            gap: 10px; /* Gap between title and sidebar content */
            flex: 1; /* Each column takes equal space */
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            margin-bottom: 5px; /* Space between title and content */
        }

        .reminders-sidebar, .weekly-reminders-sidebar, .weekly-events-sidebar, .monthly-events-sidebar {
            background: #3a3a3a;
            background-image: -webkit-linear-gradient(top, #2a2a2a 0%, #2a2a2a 40px, #3a3a3a 40px, #3a3a3a 100%);
            background-image: -moz-linear-gradient(top, #2a2a2a 0%, #2a2a2a 40px, #3a3a3a 40px, #3a3a3a 100%);
            background-image: -o-linear-gradient(top, #2a2a2a 0%, #2a2a2a 40px, #3a3a3a 40px, #3a3a3a 100%);
            background-image: -ms-linear-gradient(top, #2a2a2a 0%, #2a2a2a 40px, #3a3a3a 40px, #3a3a3a 100%);
            background-image: linear-gradient(to bottom, #2a2a2a 0%, #2a2a2a 40px, #3a3a3a 40px, #3a3a3a 100%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Enable scrolling if content overflows */
            cursor: pointer;
        }
        
        .weekly-events-sidebar {
            display: grid;
            gap: 1px;
        }

        .sidebar-box, .sidebar-week-box {
            background: #2a2a2a;
            border-radius: 0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
            cursor: pointer;
            transition: background 0.2s;
            flex-grow: 1;
        }

        .sidebar-box:hover, .sidebar-week-box:hover {
            background: #3a3a3a;
        }
        .sidebar-box.selected, .sidebar-week-box.selected {
            background: #4CAF50;
            color: white;
        }
        .sidebar-event-item {
            padding: 3px 6px;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Notes Page */
        .notes-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 1000;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .notes-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
        }

        .notes-content {
            padding: 20px;
            height: calc(100vh - 80px);
        }

        .notes-input {
            width: 100%;
            height: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            user-select: text; /* Re-enable text selection for notes input */
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column; /* Stack calendar and sidebars */
                gap: 15px;
            }
            .sidebars-container {
                flex-direction: row; /* Keep sidebars side-by-side if enough space, otherwise stack */
                flex-wrap: wrap;
                min-width: unset;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            .hamburger {
                top: 10px;
                left: 10px;
            }
            .add-event-form {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .event-checkboxes {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <button class="hamburger" onclick="toggleNotes()">☰</button>
        <div class="sidebars-container">
            <div class="sidebar-column">
                <div class="sidebar-title">Reminders</div>
                <div class="reminders-sidebar" id="remindersSidebar"></div>
            </div>
            <div class="sidebar-column">
                <div class="sidebar-title">Weekly Reminders</div>
                <div class="weekly-reminders-sidebar" id="weeklyRemindersSidebar"></div>
            </div>
        </div>

        <div class="calendar-main-content">
            <div class="header">
                <div class="month-nav">
                    <button class="nav-btn" onclick="previousMonth()">‹</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="nav-btn" onclick="nextMonth()">›</button>
                </div>
            </div>

            <div class="add-event-form">
                <button class="add-btn" id="modeBtn" onclick="toggleMode()">Add</button>
                <input type="text" class="event-input" id="eventInput" placeholder="Enter event name..." onkeypress="handleEnterKey(event)">
                <div class="event-checkboxes">
                    <div class="checkbox-group" id="allGroup">
                        <input type="checkbox" id="allEvent">
                        <label for="allEvent">All</label>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="day-header" data-col="0">Sun</div>
                    <div class="day-header" data-col="1">Mon</div>
                    <div class="day-header" data-col="2">Tue</div>
                    <div class="day-header" data-col="3">Wed</div>
                    <div class="day-header" data-col="4">Thu</div>
                    <div class="day-header" data-col="5">Fri</div>
                    <div class="day-header" data-col="6">Sat</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div class="sidebars-container">
            <div class="sidebar-column">
                <div class="sidebar-title">Weekly Events</div>
                <div class="weekly-events-sidebar" id="weeklyEventsSidebar"></div>
            </div>
            <div class="sidebar-column">
                <div class="sidebar-title">Monthly Events</div>
                <div class="monthly-events-sidebar" id="monthlyEventsSidebar"></div>
            </div>
        </div>

        <div class="notes-page" id="notesPage">
            <div class="notes-header">
                <div class="notes-title">Notes</div>
                <button class="close-btn" onclick="toggleNotes()">Done</button>
            </div>
            <div class="notes-content">
                <textarea class="notes-input" id="notesInput" placeholder="Start typing your notes here..."></textarea>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let removeMode = false;

        let events = {
            day: {},
            reminders: [],
            weeklyReminders: [], // Array of {name: string, days: number[]}
            weeklyEvents: {},
            monthlyEvents: [] // Array of {name: string, day: number | null}
        };
        
        let selections = {
            calendar: [], 
            reminders: [], 
            weeklyReminders: [], 
            weeklyEvents: [], 
            monthlyEvents: [] 
        };
        
        let lastInteractedGroup = 'calendar';
        let isDragging = false;
        let dragStartKey = null; 
        
        let selectionAnchor = {
            calendar: null, 
            weeklyEvents: null 
        };

        let undoStack = [];
        const MAX_HISTORY = 20;
        const WEEKDAY_ABBREVIATIONS = ['Su', 'M', 'T', 'W', 'Th', 'F', 'Sa'];

        // --- Utility functions ---
        function formatDate(date) {
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0');
        }

        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function getWeekKey(date) {
            const startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - date.getDay());
            return formatDate(startOfWeek);
        }

        // --- Save and Load Events/Notes ---
        function saveEvents() {
            localStorage.setItem("calendarEvents", JSON.stringify(events));
        }

        function loadEvents() {
            const savedEvents = localStorage.getItem("calendarEvents");
            if (savedEvents) {
                let loaded = JSON.parse(savedEvents);
                
                // --- Data Migration from old format ---
                if (loaded.weeklyReminders && !Array.isArray(loaded.weeklyReminders)) {
                    const newWeeklyReminders = [];
                    Object.keys(loaded.weeklyReminders).forEach(dayIndex => {
                        if(Array.isArray(loaded.weeklyReminders[dayIndex])) {
                            loaded.weeklyReminders[dayIndex].forEach(name => {
                                const existingEvent = newWeeklyReminders.find(e => e.name === name);
                                if (existingEvent) {
                                    existingEvent.days.push(parseInt(dayIndex));
                                } else {
                                    newWeeklyReminders.push({ name: name, days: [parseInt(dayIndex)] });
                                }
                            });
                        }
                    });
                    loaded.weeklyReminders = newWeeklyReminders;
                }

                if (loaded.monthlyEvents && !Array.isArray(loaded.monthlyEvents)) {
                    const newMonthlyEvents = [];
                     Object.keys(loaded.monthlyEvents).forEach(dayNum => {
                        if(Array.isArray(loaded.monthlyEvents[dayNum])) {
                            loaded.monthlyEvents[dayNum].forEach(name => {
                                newMonthlyEvents.push({ name: name, day: parseInt(dayNum) });
                            });
                        }
                    });
                    loaded.monthlyEvents = newMonthlyEvents;
                }
                
                events = loaded;
            }
            // Ensure all event groups exist to prevent errors
            events.day = events.day || {};
            events.reminders = events.reminders || [];
            events.weeklyReminders = events.weeklyReminders || [];
            events.weeklyEvents = events.weeklyEvents || {};
            events.monthlyEvents = events.monthlyEvents || [];
        }

        function saveNotes() {
            const notesInput = document.getElementById('notesInput');
            localStorage.setItem("notes", notesInput.value);
        }

        function loadNotes() {
            const notesInput = document.getElementById('notesInput');
            const savedNotes = localStorage.getItem("notes");
            if (savedNotes) {
                notesInput.value = savedNotes;
            }
        }

        // --- Undo/Redo State Management ---
        function saveState() {
            if (undoStack.length >= MAX_HISTORY) {
                undoStack.shift();
            }
            undoStack.push(JSON.parse(JSON.stringify(events)));
        }

        function undo() {
            if (undoStack.length > 1) {
                undoStack.pop();
                events = JSON.parse(JSON.stringify(undoStack[undoStack.length - 1]));
                renderAll();
                saveEvents();
            } else if (undoStack.length === 1) {
                events = { day: {}, reminders: [], weeklyReminders: [], weeklyEvents: {}, monthlyEvents: [] };
                undoStack = [JSON.parse(JSON.stringify(events))];
                renderAll();
                saveEvents();
            }
        }
        
        // --- App Initialization ---
        function init() {
            loadEvents();
            saveState();
            loadNotes();
            
            document.getElementById('modeBtn').textContent = removeMode ? "Remove" : "Add";
            document.getElementById('allGroup').style.display = removeMode ? 'flex' : 'none';
            
            renderAll();
            
            // --- GLOBAL EVENT LISTENERS ---
            window.addEventListener('resize', updateSidebarHeights);
            document.addEventListener('mouseup', () => { 
                isDragging = false; 
                dragStartKey = null;
            });
            document.addEventListener('keydown', handleKeyDown);

            // Listener to deselect when clicking on non-interactive areas
            document.body.addEventListener('mousedown', (e) => {
                const interactiveSelectors = [
                    '.calendar-day', '.sidebar-box', '.sidebar-week-box', '.day-header',
                    '.add-event-form', '.month-nav', '.hamburger', '.notes-page', '.sidebar-event-item'
                ];
                if (e.target.closest(interactiveSelectors.join(','))) {
                    return;
                }
                clearSelections();
                highlightSelections();
            });

            // Listeners for selecting entire sidebar groups
            document.getElementById('remindersSidebar').addEventListener('click', (e) => handleSidebarHeaderClick(e, 'reminders'));
            document.getElementById('weeklyRemindersSidebar').addEventListener('click', (e) => handleSidebarHeaderClick(e, 'weeklyReminders'));
            document.getElementById('weeklyEventsSidebar').addEventListener('click', (e) => handleSidebarHeaderClick(e, 'weeklyEvents'));
            document.getElementById('monthlyEventsSidebar').addEventListener('click', (e) => handleSidebarHeaderClick(e, 'monthlyEvents'));

            // Listeners for selecting calendar columns
            document.querySelectorAll('.calendar-header .day-header').forEach(header => {
                header.addEventListener('click', (e) => handleColumnClick(e, header.dataset.col));
            });
        }

        function renderAll() {
            updateCurrentMonth();
            updateCalendar();
            updateSidebars();
            highlightSelections();
            requestAnimationFrame(updateSidebarHeights);
        }

        // --- UI Interaction ---
        function toggleMode() {
            removeMode = !removeMode;
            document.getElementById("modeBtn").textContent = removeMode ? "Remove" : "Add";
            document.getElementById('allGroup').style.display = removeMode ? 'flex' : 'none';
            clearSelections();
            renderAll();
        }

        function updateCurrentMonth() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderAll();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderAll();
        }

        // --- Calendar Grid Update ---
        function updateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateKey = formatDate(date);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (date.getMonth() !== currentDate.getMonth()) dayElement.classList.add('other-month');
                if (formatDate(date) === formatDate(today)) dayElement.classList.add('today');

                dayElement.dataset.date = dateKey;
                dayElement.dataset.col = date.getDay();

                dayElement.addEventListener('mousedown', (e) => handleInteractionStart(e, 'calendar', dateKey));
                dayElement.addEventListener('mouseenter', (e) => handleInteractionDrag(e, 'calendar', dateKey));
                dayElement.addEventListener('click', (e) => handleInteractionClick(e, 'calendar', dateKey));

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();

                const dayEvents = document.createElement('div');
                dayEvents.className = 'day-events';
                if (events.day[dateKey]) {
                    events.day[dateKey].forEach(event => {
                        dayEvents.appendChild(createEventElement(event, () => {
                             document.getElementById("eventInput").value = event;
                             lastInteractedGroup = 'calendar';
                        }));
                    });
                }
                
                dayElement.appendChild(dayNumber);
                dayElement.appendChild(dayEvents);
                calendarGrid.appendChild(dayElement);
            }
        }

        // --- Selection Logic ---
        function getSelectedGroups() {
            return Object.keys(selections).filter(g => selections[g].length > 0);
        }

        function isValidSelectionCombination(newGroup) {
            const currentGroups = getSelectedGroups();
            if (currentGroups.includes(newGroup)) return true;

            const proposedGroups = [...currentGroups, newGroup];
            if (proposedGroups.length <= 1) return true;

            const validPairs = [
                ['calendar', 'weeklyReminders'],
                ['calendar', 'monthlyEvents']
            ];

            if (proposedGroups.length === 2) {
                const sortedProposed = proposedGroups.sort().join(',');
                return validPairs.some(pair => pair.sort().join(',') === sortedProposed);
            }
            
            return false;
        }

        function handleInteractionStart(e, group, key) {
            if (e.button !== 0) return; 
            isDragging = true;
            dragStartKey = key;
            
            if (!isValidSelectionCombination(group)) {
                clearSelections();
            }
            lastInteractedGroup = group;
            
            if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
                const isSelected = selections[group].includes(key);
                if (!isSelected || selections[group].length > 1 || getSelectedGroups().length > 1) {
                    if (!isValidSelectionCombination(group)) {
                        clearSelections();
                    }
                    selections[group] = [key];
                    selectionAnchor[group] = key;
                }
            }
            highlightSelections();
        }

        function handleInteractionDrag(e, group, key) {
            if (!isDragging || e.buttons !== 1) return;

            let keysToSelect = [];
            if (group === 'calendar') {
                if (e.ctrlKey || e.metaKey) { 
                    const startDayCol = parseDate(dragStartKey).getDay();
                    if (parseDate(key).getDay() !== startDayCol) return; 

                    const allColumnDates = Array.from(document.querySelectorAll(`.calendar-day[data-col="${startDayCol}"]`)).map(el => el.dataset.date);
                    keysToSelect = getKeysBetween(dragStartKey, key, allColumnDates);
                } else { 
                    const allDates = Array.from(document.querySelectorAll('.calendar-day')).map(el => el.dataset.date);
                    keysToSelect = getKeysBetween(dragStartKey, key, allDates);
                }
            } else if (group === 'weeklyEvents') {
                 const allWeekKeys = Array.from(document.querySelectorAll('.sidebar-week-box')).map(el => el.dataset.key).sort();
                 keysToSelect = getKeysBetween(dragStartKey, key, allWeekKeys);
            }

            if (!e.ctrlKey && !e.metaKey) {
                 if (!isValidSelectionCombination(group)) {
                    clearSelections();
                 } else {
                    Object.keys(selections).forEach(g => { if (g !== group) selections[g] = []; });
                 }
                 selections[group] = keysToSelect;
            } else {
                selections[group] = [...new Set([...selections[group], ...keysToSelect])];
            }
            highlightSelections();
        }

        function handleInteractionClick(e, group, key) {
            isDragging = false;
            
            if (!isValidSelectionCombination(group)) {
                clearSelections();
            }
            lastInteractedGroup = group;
            const isSelected = selections[group].includes(key);
            
            if (e.shiftKey && selectionAnchor[group]) { 
                if (!e.ctrlKey && !e.metaKey) {
                    if (!isValidSelectionCombination(group)) clearSelections();
                    else Object.keys(selections).forEach(g => { if (g !== group) selections[g] = []; });
                }
                let allKeys = [];
                if (group === 'calendar') allKeys = Array.from(document.querySelectorAll('.calendar-day')).map(el => el.dataset.date);
                if (group === 'weeklyEvents') allKeys = Array.from(document.querySelectorAll('.sidebar-week-box')).map(el => el.dataset.key).sort();
                
                const range = getKeysBetween(selectionAnchor[group], key, allKeys);
                selections[group] = [...new Set([...selections[group], ...range])];

            } else if (e.ctrlKey || e.metaKey) {
                selections[group] = isSelected ? selections[group].filter(k => k !== key) : [...selections[group], key];
                selectionAnchor[group] = key;
            } else {
                clearSelections();
                selections[group] = [key];
                selectionAnchor[group] = key;
            }
            highlightSelections();
        }
        
        function handleSingleBoxClick(e, groupName, key) {
            e.stopPropagation();
            if (!isValidSelectionCombination(groupName)) {
                clearSelections();
            }
            lastInteractedGroup = groupName;
            const isSelected = selections[groupName].includes(key);

            if (e.ctrlKey || e.metaKey) {
                selections[groupName] = isSelected ? [] : [key];
            } else {
                const wasOnlySelection = isSelected && getSelectedGroups().flat().length === 1;
                if (!isValidSelectionCombination(groupName)) clearSelections();
                else {
                    const currentGroups = getSelectedGroups();
                    if(currentGroups.length > 1 || !currentGroups.includes(groupName)) {
                        clearSelections();
                    }
                }
                if (!wasOnlySelection) {
                    selections[groupName] = [key];
                } else {
                    selections[groupName] = [];
                }
            }
            highlightSelections();
        }

        function handleColumnClick(e, colIndex) {
            e.stopPropagation();
            if (!isValidSelectionCombination('calendar')) {
                clearSelections();
            }
            lastInteractedGroup = 'calendar';

            const columnDates = Array.from(document.querySelectorAll(`.calendar-day[data-col="${colIndex}"]`)).map(el => el.dataset.date);
            const areAllSelected = columnDates.every(date => selections.calendar.includes(date));

            if (e.ctrlKey || e.metaKey) {
                if (areAllSelected) {
                    selections.calendar = selections.calendar.filter(date => !columnDates.includes(date));
                } else {
                    selections.calendar = [...new Set([...selections.calendar, ...columnDates])];
                }
            } else {
                const isOnlySelection = selections.calendar.length === columnDates.length && areAllSelected;
                clearSelections();
                if (!isOnlySelection) {
                    selections.calendar = columnDates;
                }
            }
            highlightSelections();
        }

        function handleSidebarHeaderClick(e, groupName) {
            const sidebar = e.currentTarget;
            const headerHeight = document.querySelector('.calendar-header').offsetHeight;

            if (e.target !== sidebar || e.offsetY >= headerHeight) {
                return;
            }
            e.stopPropagation();

            if (!isValidSelectionCombination(groupName)) {
                clearSelections();
            }
            lastInteractedGroup = groupName;

            let allKeysInGroup = [];
            if (groupName === 'weeklyEvents') {
                allKeysInGroup = Array.from(sidebar.querySelectorAll('.sidebar-week-box')).map(el => el.dataset.key);
            } else {
                allKeysInGroup = [groupName];
            }

            if (allKeysInGroup.length === 0) return;

            const areAllSelected = allKeysInGroup.every(k => selections[groupName].includes(k));

            if (e.ctrlKey || e.metaKey) {
                if (areAllSelected) {
                    selections[groupName] = selections[groupName].filter(k => !allKeysInGroup.includes(k));
                } else {
                    selections[groupName] = [...new Set([...selections[groupName], ...allKeysInGroup])];
                }
            } else {
                const isOnlySelection = getSelectedGroups().length === 1 && getSelectedGroups()[0] === groupName && selections[groupName].length === allKeysInGroup.length && areAllSelected;
                clearSelections();
                if (!isOnlySelection) {
                    selections[groupName] = allKeysInGroup;
                }
            }
            highlightSelections();
        }

        function getKeysBetween(key1, key2, allKeys) {
            const index1 = allKeys.indexOf(key1);
            const index2 = allKeys.indexOf(key2);
            if (index1 === -1 || index2 === -1) return [];
            const start = Math.min(index1, index2);
            const end = Math.max(index1, index2);
            return allKeys.slice(start, end + 1);
        }

        function clearSelections() {
             Object.keys(selections).forEach(group => {
                selections[group] = [];
             });
        }
        
        function highlightSelections() {
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.toggle('selected', selections.calendar.includes(el.dataset.date));
            });
            document.querySelectorAll('.sidebar-box, .sidebar-week-box').forEach(el => {
                const group = el.dataset.group;
                const key = el.dataset.key;
                if(group && key) {
                    el.classList.toggle('selected', selections[group].includes(key));
                }
            });
        }

        // --- Event Management ---
        function addEvent() {
            const input = document.getElementById("eventInput");
            const name = input.value.trim();
            const allEventCheckbox = document.getElementById('allEvent');
            
            const totalSelections = Object.values(selections).flat().length;
            if (totalSelections === 0 && !allEventCheckbox.checked) return;
            if (!removeMode && name === "") return;

            saveState();

            if (removeMode && allEventCheckbox.checked) {
                if (name === "") {
                    events = { day: {}, reminders: [], weeklyReminders: [], weeklyEvents: {}, monthlyEvents: [] };
                } else {
                    Object.keys(events.day).forEach(k => {
                        events.day[k] = events.day[k].filter(e => e !== name);
                    });
                    events.reminders = events.reminders.filter(e => e !== name);
                    Object.keys(events.weeklyEvents).forEach(k => {
                        events.weeklyEvents[k] = events.weeklyEvents[k].filter(e => e !== name);
                    });
                    events.weeklyReminders = events.weeklyReminders.filter(e => e.name !== name);
                    events.monthlyEvents = events.monthlyEvents.filter(e => e.name !== name);
                }
            } else if (removeMode) {
                const hasRemindersSelection = selections.reminders.length > 0;
                const hasWeeklyRemindersSelection = selections.weeklyReminders.length > 0;
                const hasWeeklyEventsSelection = selections.weeklyEvents.length > 0;
                const hasMonthlyEventsSelection = selections.monthlyEvents.length > 0;

                selections.calendar.forEach(k => {
                    if (events.day[k]) {
                        events.day[k] = name === "" ? [] : events.day[k].filter(e => e !== name);
                    }
                });
                selections.weeklyEvents.forEach(k => {
                    if (events.weeklyEvents[k]) {
                        events.weeklyEvents[k] = name === "" ? [] : events.weeklyEvents[k].filter(e => e !== name);
                    }
                });
                if (hasRemindersSelection) {
                    events.reminders = name === "" ? [] : events.reminders.filter(e => e !== name);
                }
                if (hasWeeklyRemindersSelection) {
                    if (name === "") events.weeklyReminders = [];
                    else events.weeklyReminders = events.weeklyReminders.filter(e => e.name !== name);
                }
                if (hasMonthlyEventsSelection) {
                    if (name === "") events.monthlyEvents = [];
                    else events.monthlyEvents = events.monthlyEvents.filter(e => e.name !== name);
                }
            } else { 
                const hasCalendarSelection = selections.calendar.length > 0;
                const hasRemindersSelection = selections.reminders.length > 0;
                const hasWeeklyRemindersSelection = selections.weeklyReminders.length > 0;
                const hasWeeklyEventsSelection = selections.weeklyEvents.length > 0;
                const hasMonthlyEventsSelection = selections.monthlyEvents.length > 0;

                if (hasWeeklyRemindersSelection && hasCalendarSelection) {
                     const dayIndices = selections.calendar.map(d => parseDate(d).getDay());
                     const existingEvent = events.weeklyReminders.find(e => e.name === name);
                     if (existingEvent) {
                         existingEvent.days = [...new Set([...existingEvent.days, ...dayIndices])].sort((a, b) => a - b);
                     } else {
                         events.weeklyReminders.push({ name: name, days: [...new Set(dayIndices)].sort((a, b) => a - b) });
                     }
                } 
                else if (hasMonthlyEventsSelection && hasCalendarSelection) {
                    selections.calendar.forEach(dateStr => {
                        const dayOfMonth = parseDate(dateStr).getDate();
                        const isDuplicate = events.monthlyEvents.some(e => e.name === name && e.day === dayOfMonth);
                        if (!isDuplicate) {
                            events.monthlyEvents.push({ name: name, day: dayOfMonth });
                        }
                    });
                } 
                else if (hasRemindersSelection) {
                    if (!events.reminders.includes(name)) events.reminders.push(name);
                } 
                else if (hasWeeklyRemindersSelection) {
                    events.weeklyReminders = events.weeklyReminders.filter(e => e.name !== name);
                    events.weeklyReminders.push({ name: name, days: [] });
                } 
                else if (hasMonthlyEventsSelection) {
                    events.monthlyEvents = events.monthlyEvents.filter(e => e.name !== name);
                    events.monthlyEvents.push({ name: name, day: null });
                }
                else if (hasWeeklyEventsSelection) {
                    selections.weeklyEvents.forEach(k => {
                        events.weeklyEvents[k] = events.weeklyEvents[k] || [];
                        if (!events.weeklyEvents[k].includes(name)) events.weeklyEvents[k].push(name);
                    });
                }
                else if (hasCalendarSelection) {
                    selections.calendar.forEach(k => {
                        events.day[k] = events.day[k] || [];
                        if (!events.day[k].includes(name)) events.day[k].push(name);
                    });
                }
            }

            if (!removeMode) input.value = "";
            saveEvents();
            renderAll();
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') addEvent();
        }
        
        function createEventElement(text, onClick) {
            const eventElement = document.createElement('div');
            eventElement.className = 'sidebar-event-item';
            eventElement.textContent = text;
            eventElement.onclick = (e) => { e.stopPropagation(); onClick(); };
            return eventElement;
        }

        // --- Sidebar Updates ---
        function updateSidebars() {
            const sidebars = {
                reminders: document.getElementById('remindersSidebar'),
                weeklyReminders: document.getElementById('weeklyRemindersSidebar'),
                weeklyEvents: document.getElementById('weeklyEventsSidebar'),
                monthlyEvents: document.getElementById('monthlyEventsSidebar'),
            };
            Object.values(sidebars).forEach(s => s.innerHTML = '');

            const remindersBox = document.createElement('div');
            remindersBox.className = 'sidebar-box';
            remindersBox.dataset.group = 'reminders';
            remindersBox.dataset.key = 'reminders';
            remindersBox.addEventListener('click', (e) => handleSingleBoxClick(e, 'reminders', 'reminders'));
            events.reminders.forEach(event => remindersBox.appendChild(createEventElement(event, () => document.getElementById("eventInput").value = event)));
            sidebars.reminders.appendChild(remindersBox);

            const weeklyRemindersBox = document.createElement('div');
            weeklyRemindersBox.className = 'sidebar-box';
            weeklyRemindersBox.dataset.group = 'weeklyReminders';
            weeklyRemindersBox.dataset.key = 'weeklyReminders';
            weeklyRemindersBox.addEventListener('click', (e) => handleSingleBoxClick(e, 'weeklyReminders', 'weeklyReminders'));
            events.weeklyReminders.forEach(event => {
                let eventText = event.name;
                if (event.days.length > 0) {
                    const dayStr = event.days.map(d => WEEKDAY_ABBREVIATIONS[d]).join('/');
                    eventText += ` (${dayStr})`;
                }
                weeklyRemindersBox.appendChild(createEventElement(eventText, () => document.getElementById("eventInput").value = event.name));
            });
            sidebars.weeklyReminders.appendChild(weeklyRemindersBox);
            
            const firstDayInGrid = parseDate(document.querySelector('.calendar-day')?.dataset.date || formatDate(new Date()));
            for (let i = 0; i < 6; i++) {
                const weekStart = new Date(firstDayInGrid);
                weekStart.setDate(firstDayInGrid.getDate() - firstDayInGrid.getDay() + i * 7);
                const weekKey = getWeekKey(weekStart);

                const weekBox = document.createElement('div');
                weekBox.className = 'sidebar-week-box';
                weekBox.dataset.group = 'weeklyEvents';
                weekBox.dataset.key = weekKey;
                weekBox.addEventListener('mousedown', (e) => handleInteractionStart(e, 'weeklyEvents', weekKey));
                weekBox.addEventListener('mouseenter', (e) => handleInteractionDrag(e, 'weeklyEvents', weekKey));
                weekBox.addEventListener('click', (e) => handleInteractionClick(e, 'weeklyEvents', weekKey));

                if (events.weeklyEvents[weekKey]) {
                    events.weeklyEvents[weekKey].forEach(event => {
                        weekBox.appendChild(createEventElement(event, () => document.getElementById("eventInput").value = event));
                    });
                }
                sidebars.weeklyEvents.appendChild(weekBox);
            }

            const monthBox = document.createElement('div');
            monthBox.className = 'sidebar-box';
            monthBox.dataset.group = 'monthlyEvents';
            monthBox.dataset.key = 'monthlyEvents';
            monthBox.addEventListener('click', (e) => handleSingleBoxClick(e, 'monthlyEvents', 'monthlyEvents'));
            const sortedMonthly = [...events.monthlyEvents].sort((a,b) => (a.day || 99) - (b.day || 99));
            sortedMonthly.forEach(event => {
                const eventText = event.day ? `${event.day} ${event.name}` : event.name;
                monthBox.appendChild(createEventElement(eventText, () => document.getElementById("eventInput").value = event.name));
            });
            sidebars.monthlyEvents.appendChild(monthBox);
        }

        function updateSidebarHeights() {
            const calendarHeader = document.querySelector('.calendar-header');
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarHeader || !calendarGrid || calendarGrid.offsetHeight === 0) return;

            const calendarHeaderHeight = calendarHeader.offsetHeight;
            const totalCalendarGridHeight = calendarGrid.offsetHeight;
            const sidebarContainerHeight = totalCalendarGridHeight + 40;

            const sidebarContainers = document.querySelectorAll(
                '.reminders-sidebar, .weekly-reminders-sidebar, .weekly-events-sidebar, .monthly-events-sidebar'
            );
            
            sidebarContainers.forEach(container => {
                container.style.height = `${sidebarContainerHeight}px`;
                container.style.paddingTop = `${calendarHeaderHeight}px`;
            });

            const weeklyEventsSidebar = document.getElementById('weeklyEventsSidebar');
            const weeklyEventBoxes = Array.from(weeklyEventsSidebar.querySelectorAll('.sidebar-week-box'));
            const calendarDays = Array.from(calendarGrid.querySelectorAll('.calendar-day'));

            if (weeklyEventBoxes.length === 6 && calendarDays.length === 42) {
                for (let i = 0; i < 6; i++) {
                    const calendarRowCell = calendarDays[i * 7];
                    if (calendarRowCell) {
                        const calendarRowHeight = calendarRowCell.offsetHeight;
                        weeklyEventBoxes[i].style.height = `${calendarRowHeight}px`;
                    }
                }
            }
        }

        // --- Notes Page ---
        function toggleNotes() {
            const notesPage = document.getElementById('notesPage');
            const isVisible = notesPage.style.display === 'block';
            notesPage.style.display = isVisible ? 'none' : 'block';
            if (isVisible) saveNotes();
        }

        // --- Keyboard Shortcuts ---
        function handleKeyDown(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
                event.preventDefault();
                undo();
            }
        }

        window.addEventListener("beforeunload", saveEvents);
        window.addEventListener("beforeunload", saveNotes);
        init();
    </script>
</body>
</html>

<!---
I want you to see if you can optimize this code so that it takes up less than 14kB of space, or at least compact the code to the best of your abilities.

Typically this involving getting rid of the autoplaying videos, the popups, the cookies, the cookie consent banners, the social network buttons, the tracking scripts, javascript and css frameworks, or anything else unneeded that could be taking up space. But it could also involve writing more efficient code as is likely the case with this .html file.

Additionally, I want you to explain how TCP decides which 14kB of data is the first to be sent, and how I can change my code so that the most important elements are send within the first 14kB batch.

linear-gradient(340deg, rgba(40,42,45,0) 71.78%, rgba(7,110,255,0.4) 98.73%)
border: 2px solid #076eff
border-radius: 20px;
color: #e2e2e5
color: #87a9ff

font-family: "Google Sans Text","Helvetica Neue",sans-serif;
letter-spacing: normal;
font-size: 14px;
font-weight: 500;
line-height: 20px;

button...
color: white
background-color: #1a73e8
...deactivated
cursor: default;
pointer-events: none;
color: color-mix(in srgb, white 38%, transparent)
background-color: color-mix(in srgb, white 12%, transparent)
--->